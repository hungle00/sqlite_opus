#!/bin/bash -e

# Create /data/uploads directory if it doesn't exist (for volume mount)
mkdir -p /data/uploads

# Create symlink from /rails/storage/uploads to /data/uploads (volume mount)
# This allows using single volume for both database and uploads
if [ ! -L storage/uploads ]; then
  # Remove existing directory if it exists and create symlink
  if [ -d storage/uploads ]; then
    rm -rf storage/uploads
  fi
  ln -s /data/uploads storage/uploads
  echo "Created symlink: storage/uploads -> /data/uploads"
fi

# Copy seed database file if it doesn't exist (for volume mounting scenarios)
if [ ! -f "/data/uploads/chinook.db" ] && [ -f "/rails/storage/uploads/chinook.db" ]; then
  cp /rails/storage/uploads/chinook.db /data/uploads/chinook.db
  echo "Copied seed database chinook.db to /data/uploads/"
fi

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
