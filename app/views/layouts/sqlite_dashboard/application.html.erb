<!DOCTYPE html>
<html>
  <head>
    <title>SQLite Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">

    <style>
      :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --sidebar-bg: #1e293b;
        --sidebar-text: #e2e8f0;
        --sidebar-hover: #334155;
        --main-bg: #f8fafc;
        --card-bg: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --success-bg: #dcfce7;
        --success-border: #86efac;
        --success-text: #166534;
        --error-bg: #fee2e2;
        --error-border: #fca5a5;
        --error-text: #991b1b;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--main-bg);
        color: var(--text-primary);
      }

      .sqlite-dashboard-container {
        height: 100vh;
        overflow: hidden;
      }

      .sidebar {
        background-color: var(--sidebar-bg);
        border-right: 2px solid #334155;
        height: 100vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
      }

      .sidebar h6 {
        color: var(--sidebar-text);
        font-weight: 600;
        letter-spacing: 0.025em;
      }

      .sidebar .btn-outline-secondary {
        color: var(--sidebar-text);
        border-color: #475569;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
      }

      .sidebar .btn-outline-secondary:hover {
        background-color: var(--sidebar-hover);
        border-color: #64748b;
        color: #f1f5f9;
        transform: translateX(-2px);
      }

      .main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: var(--main-bg);
      }

      .query-console {
        background-color: var(--card-bg);
        border-bottom: 2px solid var(--border-color);
        padding: 1.5rem;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
      }

      .query-console .form-label {
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
      }

      .query-textarea {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 13px;
        min-height: 120px;
      }

      .CodeMirror {
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        height: 150px;
        font-size: 14px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }

      .CodeMirror-focused {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
      }

      .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .btn-outline-secondary {
        border-color: var(--border-color);
        color: var(--text-secondary);
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn-outline-secondary:hover {
        background-color: var(--main-bg);
        border-color: var(--text-secondary);
        color: var(--text-primary);
      }

      .results-container {
        flex: 1;
        overflow: auto;
        padding: 1.5rem;
        background-color: var(--main-bg);
      }

      .table-wrapper {
        overflow-x: auto;
        max-width: 100%;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        background-color: var(--card-bg);
        box-shadow: var(--shadow-md);
      }

      .table-wrapper table {
        margin-bottom: 0;
      }

      .table {
        color: var(--text-primary);
      }

      .table thead {
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }

      .table thead th {
        padding: 1rem 0.75rem;
        border-bottom: 2px solid #334155;
      }

      .table tbody tr {
        transition: all 0.15s ease;
      }

      .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8fafc;
      }

      .table-hover tbody tr:hover {
        background-color: #e0f2fe;
        transform: scale(1.001);
      }

      .table tbody td {
        padding: 0.875rem 0.75rem;
        border-color: var(--border-color);
        font-size: 0.875rem;
      }

      .export-controls {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
      }

      .btn-group {
        box-shadow: var(--shadow-sm);
        border-radius: 0.375rem;
      }

      .btn-group .btn {
        border-radius: 0;
      }

      .btn-group .btn:first-child {
        border-top-left-radius: 0.375rem;
        border-bottom-left-radius: 0.375rem;
      }

      .btn-group .btn:last-child {
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
      }

      .btn-success {
        background-color: #16a34a;
        border-color: #16a34a;
        color: white;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn-success:hover {
        background-color: #15803d;
        border-color: #15803d;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .btn-info {
        background-color: #0ea5e9;
        border-color: #0ea5e9;
        color: white;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn-info:hover {
        background-color: #0284c7;
        border-color: #0284c7;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .pagination-controls {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 1rem 1.5rem;
        gap: 1.5rem;
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border: 2px solid var(--border-color);
      }

      @media (max-width: 768px) {
        .pagination-controls {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .rows-per-page {
          justify-content: center;
        }

        .pagination-info {
          text-align: center;
          order: 3;
        }

        .pagination-buttons {
          justify-content: center;
          order: 2;
        }
      }

      .pagination-info {
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.875rem;
        text-align: center;
        white-space: nowrap;
      }

      .pagination-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: flex-end;
      }

      .pagination-buttons .btn {
        padding: 0.5rem 0.75rem;
        border-width: 2px;
        min-width: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pagination-buttons span {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-primary);
      }

      .rows-per-page {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        justify-content: flex-start;
      }

      .rows-per-page label {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
        white-space: nowrap;
      }

      .rows-per-page select {
        width: auto;
        min-width: 80px;
        border: 2px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-weight: 500;
        background-color: var(--card-bg);
        transition: all 0.2s ease;
      }

      .rows-per-page select:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .table-sidebar {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .table-sidebar li {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #334155;
        color: var(--sidebar-text);
        transition: all 0.2s ease;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .table-sidebar li i {
        color: #94a3b8;
        width: 16px;
      }

      .table-sidebar li:hover {
        background-color: var(--sidebar-hover);
        padding-left: 1.25rem;
        color: #f1f5f9;
      }

      .table-sidebar li.active {
        background-color: var(--primary-color);
        color: white;
        border-left: 4px solid #60a5fa;
        font-weight: 600;
      }

      .table-sidebar li.active i {
        color: #93c5fd;
      }

      .saved-query-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #334155;
        border-radius: 0.375rem;
        border: 1px solid #475569;
        transition: all 0.2s ease;
      }

      .saved-query-item:hover {
        background-color: #475569;
        border-color: #64748b;
      }

      .saved-query-item .fw-bold {
        color: var(--sidebar-text);
        margin-bottom: 0.25rem;
      }

      .saved-query-item .text-muted {
        color: #94a3b8;
      }

      .saved-query-item .text-info {
        color: #60a5fa;
      }

      .error-message {
        background-color: var(--error-bg);
        border: 2px solid var(--error-border);
        border-left: 4px solid #dc2626;
        color: var(--error-text);
        padding: 1.25rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        font-size: 0.875rem;
      }

      .error-message i {
        margin-right: 0.5rem;
      }

      .success-message {
        background-color: var(--success-bg);
        border: 2px solid var(--success-border);
        border-left: 4px solid #16a34a;
        color: var(--success-text);
        padding: 1.25rem;
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        font-size: 0.875rem;
      }

      .success-message i {
        margin-right: 0.5rem;
      }

      /* Database index page */
      .databases-index-page {
        background-color: var(--main-bg);
      }

      .index-sidebar {
        position: relative;
      }

      .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: rgba(37, 99, 235, 0.1);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .sidebar-brand i {
        font-size: 2rem;
        color: var(--primary-color);
      }

      .sidebar-brand h6 {
        color: var(--sidebar-text);
        font-weight: 600;
        font-size: 0.875rem;
      }

      .sidebar-brand small {
        color: #94a3b8;
        font-size: 0.75rem;
      }

      .sidebar-stats {
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .stat-item i {
        font-size: 1.5rem;
        color: var(--primary-color);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--sidebar-text);
        line-height: 1;
      }

      .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .database-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .database-list li {
        margin-bottom: 0.25rem;
      }

      .database-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        color: var(--sidebar-text);
        text-decoration: none;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
      }

      .database-link i:first-child {
        color: #94a3b8;
        width: 16px;
      }

      .database-link span {
        flex: 1;
      }

      .database-link .ms-auto {
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .database-link:hover {
        background-color: var(--sidebar-hover);
        color: #f1f5f9;
        padding-left: 1rem;
      }

      .database-link:hover .ms-auto {
        opacity: 1;
      }

      .index-main-content {
        padding: 2rem 3rem;
      }

      .content-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .page-title i {
        color: var(--primary-color);
      }

      .page-subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
        margin: 0;
      }

      .databases-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
      }

      .database-card-modern {
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .database-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
      }

      .database-card-icon {
        width: 60px;
        height: 60px;
        background-color: rgba(37, 99, 235, 0.1);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        color: var(--primary-color);
      }

      .database-card-content {
        flex: 1;
      }

      .database-card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.75rem 0;
      }

      .database-card-path {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        word-break: break-all;
      }

      .database-card-path i {
        flex-shrink: 0;
        color: #94a3b8;
      }

      .database-card-actions {
        padding-top: 1rem;
        border-top: 2px solid var(--border-color);
      }

      .btn-card-action {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
      }

      .btn-card-action i {
        transition: transform 0.2s ease;
      }

      .btn-card-action:hover i {
        transform: translateX(4px);
      }

      /* Saved Queries Grid */
      .saved-queries-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
      }

      .saved-query-card {
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .saved-query-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: #94a3b8;
      }

      .saved-query-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 0.75rem;
      }

      .saved-query-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .saved-query-title i {
        color: var(--primary-color);
        font-size: 0.875rem;
      }

      .saved-query-description {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin: 0;
        line-height: 1.5;
      }

      .saved-query-sql {
        background-color: #f8fafc;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 0.75rem;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 0.75rem;
        overflow-x: auto;
      }

      .saved-query-sql code {
        color: #1e293b;
        background: none;
      }

      .saved-query-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
      }

      /* Empty state */
      .empty-state-modern {
        max-width: 700px;
        margin: 4rem auto;
        text-align: center;
        background-color: var(--card-bg);
        padding: 3rem 2rem;
        border-radius: 0.75rem;
        border: 2px solid var(--border-color);
        box-shadow: var(--shadow-sm);
      }

      .empty-state-modern .empty-state-icon {
        width: 80px;
        height: 80px;
        background-color: var(--main-bg);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: #94a3b8;
        margin-bottom: 1.5rem;
      }

      .empty-state-modern h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
      }

      .empty-state-modern p {
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      .empty-state-code {
        background-color: var(--main-bg);
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: left;
      }

      .empty-state-code pre {
        margin: 0;
        background-color: transparent;
        border: none;
        padding: 0;
      }

      .empty-state-code code {
        color: var(--text-primary);
        font-size: 0.875rem;
      }

      /* Legacy card support */
      .card {
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        background-color: var(--card-bg);
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
      }

      .card-title {
        color: var(--text-primary);
        font-weight: 600;
      }

      .card-text {
        color: var(--text-secondary);
      }

      /* Empty state styling */
      .text-muted.text-center {
        color: var(--text-secondary) !important;
      }

      .text-white {
        color: white !important;
      }

      .text-muted.text-center i {
        color: var(--border-color);
      }

      /* Alert styling */
      .alert-warning {
        background-color: #fef3c7;
        border: 2px solid #fde047;
        border-left: 4px solid #eab308;
        color: #713f12;
        border-radius: 0.5rem;
      }

      .alert-warning .alert-heading {
        font-weight: 600;
        color: #713f12;
      }

      .alert-warning pre {
        background-color: #fefce8;
        border: 1px solid #fde047;
        border-radius: 0.375rem;
        padding: 1rem;
        color: #854d0e;
      }

      /* Scrollbar styling */
      .sidebar::-webkit-scrollbar,
      .results-container::-webkit-scrollbar {
        width: 8px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: #0f172a;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      .results-container::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      .results-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }

      .results-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>

    <!-- CodeMirror JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/sql-hint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">

    <script type="module">
      import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

      // Query Executor Controller
      class QueryExecutorController extends Controller {
        static targets = ["queryInput", "queryName", "queryDescription", "saveError"]

        initialize() {
          this.currentPage = 1
          this.rowsPerPage = 25
          this.allData = null
        }

        connect() {
          // Initialize CodeMirror on the textarea
          if (this.hasQueryInputTarget && !this.editor) {
            this.editor = CodeMirror.fromTextArea(this.queryInputTarget, {
              mode: 'text/x-sql',
              theme: 'default',
              lineNumbers: true,
              matchBrackets: true,
              autoCloseBrackets: true,
              lineWrapping: true,
              extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Cmd-Enter": () => this.executeQuery(),
                "Ctrl-Enter": () => this.executeQuery()
              }
            })

            // Set initial value
            this.editor.setValue(this.queryInputTarget.value || "SELECT * FROM sqlite_master WHERE type='table';")

            // Store editor reference globally for table selector
            window.sqlEditor = this.editor
          }
        }

        execute(event) {
          event.preventDefault()
          this.executeQuery()
        }

        executeQuery() {
          const form = this.element.querySelector('form') || this.element
          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content

          // Create FormData and add the query
          const formData = new FormData()
          formData.append('query', query)

          fetch(form.action, {
            method: form.method || 'POST',
            body: formData,
            headers: {
              'X-CSRF-Token': csrfToken,
              'Accept': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            console.log("Query response:", data)
            this.allData = data
            this.currentPage = 1
            this.displayResults()
          })
          .catch(error => {
            console.error("Query error:", error)
            this.displayError(error.message || "An error occurred")
          })
        }

        displayResults() {
          const resultsDiv = document.getElementById("query-results")

          if (!this.allData) return

          if (this.allData.error) {
            this.displayError(this.allData.error)
            return
          }

          if (this.allData.columns && this.allData.columns.length > 0) {
            const totalRows = this.allData.rows.length
            const totalPages = Math.ceil(totalRows / this.rowsPerPage)
            const startIndex = (this.currentPage - 1) * this.rowsPerPage
            const endIndex = Math.min(startIndex + this.rowsPerPage, totalRows)
            const pageRows = this.allData.rows.slice(startIndex, endIndex)

            let html = `
              <div class="export-controls">
                <div class="btn-group">
                  <button class="btn btn-sm btn-success" onclick="window.queryController.showExportModal('csv')">
                    <i class="fas fa-file-csv"></i> Export CSV
                  </button>
                  <button class="btn btn-sm btn-info" onclick="window.queryController.showExportModal('json')">
                    <i class="fas fa-file-code"></i> Export JSON
                  </button>
                </div>
              </div>
              <div class="pagination-controls">
                <div class="rows-per-page">
                  <label for="rows-per-page">Rows per page:</label>
                  <select id="rows-per-page" class="form-select form-select-sm" onchange="window.queryController.changeRowsPerPage(this.value)">
                    <option value="10" ${this.rowsPerPage == 10 ? 'selected' : ''}>10</option>
                    <option value="25" ${this.rowsPerPage == 25 ? 'selected' : ''}>25</option>
                    <option value="50" ${this.rowsPerPage == 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${this.rowsPerPage == 100 ? 'selected' : ''}>100</option>
                    <option value="500" ${this.rowsPerPage == 500 ? 'selected' : ''}>500</option>
                  </select>
                </div>
                <div class="pagination-info">
                  Showing ${startIndex + 1} to ${endIndex} of ${totalRows} rows
                </div>
                <div class="pagination-buttons">
                  <button class="btn btn-sm btn-outline-secondary"
                          onclick="window.queryController.firstPage()"
                          ${this.currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-left"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary"
                          onclick="window.queryController.previousPage()"
                          ${this.currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-angle-left"></i>
                  </button>
                  <span class="px-3">Page ${this.currentPage} of ${totalPages}</span>
                  <button class="btn btn-sm btn-outline-secondary"
                          onclick="window.queryController.nextPage()"
                          ${this.currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-angle-right"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary"
                          onclick="window.queryController.lastPage()"
                          ${this.currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-angle-double-right"></i>
                  </button>
                </div>
              </div>
              <div class="table-wrapper">
                <table class="table table-striped table-hover table-bordered table-sm">
                  <thead class="table-dark sticky-top">
                    <tr>
                      ${this.allData.columns.map(col => `<th>${this.escapeHtml(col)}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${pageRows.map(row =>
                      `<tr>${row.map(val => `<td>${this.escapeHtml(String(val || ''))}</td>`).join('')}</tr>`
                    ).join('')}
                  </tbody>
                </table>
              </div>
            `
            resultsDiv.innerHTML = html

            // Store reference for pagination controls
            window.queryController = this
          } else if (this.allData.message) {
            resultsDiv.innerHTML = `
              <div class="success-message">
                <i class="fas fa-check-circle"></i> ${this.escapeHtml(this.allData.message)}
              </div>
            `
          } else {
            resultsDiv.innerHTML = `
              <div class="text-muted text-center py-5">
                <p>No results returned</p>
              </div>
            `
          }
        }

        changeRowsPerPage(value) {
          this.rowsPerPage = parseInt(value)
          this.currentPage = 1
          this.displayResults()
        }

        firstPage() {
          this.currentPage = 1
          this.displayResults()
        }

        previousPage() {
          if (this.currentPage > 1) {
            this.currentPage--
            this.displayResults()
          }
        }

        nextPage() {
          const totalPages = Math.ceil(this.allData.rows.length / this.rowsPerPage)
          if (this.currentPage < totalPages) {
            this.currentPage++
            this.displayResults()
          }
        }

        lastPage() {
          this.currentPage = Math.ceil(this.allData.rows.length / this.rowsPerPage)
          this.displayResults()
        }

        displayError(error) {
          const resultsDiv = document.getElementById("query-results")
          resultsDiv.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${this.escapeHtml(error)}
            </div>
          `
        }

        escapeHtml(text) {
          const div = document.createElement('div')
          div.textContent = text
          return div.innerHTML
        }

        clear() {
          if (this.editor) {
            this.editor.setValue("")
            this.editor.focus()
          } else {
            this.queryInputTarget.value = ""
            this.queryInputTarget.focus()
          }
        }

        showExportModal(type = 'csv') {
          const existingModal = document.getElementById('export-modal')
          if (existingModal) {
            existingModal.remove()
          }

          let modalBody = ''
          let modalTitle = ''
          let downloadButton = ''

          if (type === 'csv') {
            modalTitle = 'Export to CSV'
            modalBody = `
              <div class="mb-3">
                <label for="csv-separator" class="form-label">Separator</label>
                <select id="csv-separator" class="form-select">
                  <option value=",">Comma (,)</option>
                  <option value=";">Semicolon (;)</option>
                  <option value="\t">Tab</option>
                  <option value="|">Pipe (|)</option>
                </select>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="csv-headers" checked>
                <label class="form-check-label" for="csv-headers">
                  Include headers as first row
                </label>
              </div>
            `
            downloadButton = `
              <button type="button" class="btn btn-success" onclick="window.queryController.exportCSV()">
                <i class="fas fa-download"></i> Download CSV
              </button>
            `
          } else if (type === 'json') {
            modalTitle = 'Export to JSON'
            modalBody = `
              <div class="mb-3">
                <label for="json-format" class="form-label">Format</label>
                <select id="json-format" class="form-select">
                  <option value="array">Array of Objects</option>
                  <option value="object">Object with Columns & Rows</option>
                </select>
                <small class="form-text text-muted">
                  Array: [{"col1": "val1"}, ...] | Object: {"columns": [...], "rows": [...]}
                </small>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="json-pretty" checked>
                <label class="form-check-label" for="json-pretty">
                  Pretty print (formatted with indentation)
                </label>
              </div>
            `
            downloadButton = `
              <button type="button" class="btn btn-info" onclick="window.queryController.exportJSON()">
                <i class="fas fa-download"></i> Download JSON
              </button>
            `
          }

          const modalHtml = `
            <div class="modal fade" id="export-modal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">${modalTitle}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    ${modalBody}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    ${downloadButton}
                  </div>
                </div>
              </div>
            </div>
          `

          document.body.insertAdjacentHTML('beforeend', modalHtml)
          const modal = new bootstrap.Modal(document.getElementById('export-modal'))
          modal.show()
        }

        exportCSV() {
          const separator = document.getElementById('csv-separator').value
          const includeHeaders = document.getElementById('csv-headers').checked
          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          const form = this.element.querySelector('form') || this.element
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content

          const formData = new FormData()
          formData.append('query', query)
          formData.append('separator', separator)
          formData.append('include_headers', includeHeaders)

          fetch(form.action.replace('/execute_query', '/export_csv'), {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRF-Token': csrfToken
            }
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => { throw new Error(err.error || 'Export failed') })
            }
            return response.blob()
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `export_${new Date().getTime()}.csv`
            document.body.appendChild(a)
            a.click()
            window.URL.revokeObjectURL(url)
            a.remove()

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('export-modal'))
            if (modal) modal.hide()
          })
          .catch(error => {
            alert('Export error: ' + error.message)
          })
        }

        exportJSON() {
          const format = document.getElementById('json-format').value
          const prettyPrint = document.getElementById('json-pretty').checked
          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          const form = this.element.querySelector('form') || this.element
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content

          const formData = new FormData()
          formData.append('query', query)
          formData.append('format', format)
          formData.append('pretty_print', prettyPrint)

          fetch(form.action.replace('/execute_query', '/export_json'), {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRF-Token': csrfToken
            }
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(err => { throw new Error(err.error || 'Export failed') })
            }
            return response.blob()
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `export_${new Date().getTime()}.json`
            document.body.appendChild(a)
            a.click()
            window.URL.revokeObjectURL(url)
            a.remove()

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('export-modal'))
            if (modal) modal.hide()
          })
          .catch(error => {
            alert('Export error: ' + error.message)
          })
        }

        async saveQuery() {
          const name = this.queryNameTarget.value.trim()
          const description = this.queryDescriptionTarget.value.trim()
          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          const databaseName = this.element.dataset.databaseName

          if (!name) {
            this.showSaveError('Query name is required')
            return
          }

          if (!description) {
            this.showSaveError('Description is required')
            return
          }

          if (!query.trim()) {
            this.showSaveError('Query cannot be empty')
            return
          }

          try {
            const response = await fetch('/sqlite_dashboard/saved_queries', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
              },
              body: JSON.stringify({
                saved_query: {
                  name: name,
                  description: description,
                  query: query,
                  database_name: databaseName
                }
              })
            })

            const data = await response.json()

            if (response.ok) {
              const modal = bootstrap.Modal.getInstance(document.getElementById('saveQueryModal'))
              modal.hide()
              this.queryNameTarget.value = ''
              this.queryDescriptionTarget.value = ''
              this.hideSaveError()
              alert('Query saved successfully!')
            } else {
              this.showSaveError(data.error || 'Failed to save query')
            }
          } catch (error) {
            console.error('Error saving query:', error)
            this.showSaveError(error.message)
          }
        }

        showSaveError(message) {
          if (this.hasSaveErrorTarget) {
            this.saveErrorTarget.textContent = message
            this.saveErrorTarget.classList.remove('d-none')
          }
        }

        hideSaveError() {
          if (this.hasSaveErrorTarget) {
            this.saveErrorTarget.classList.add('d-none')
          }
        }
      }

      // Table Selector Controller
      class TableSelectorController extends Controller {
        static targets = ["tableItem"]

        selectTable(event) {
          const tableName = event.currentTarget.dataset.tableName

          // Remove active class from all items
          this.tableItemTargets.forEach(item => {
            item.classList.remove("active")
          })

          // Add active class to clicked item
          event.currentTarget.classList.add("active")

          // Update query in CodeMirror editor
          if (window.sqlEditor) {
            window.sqlEditor.setValue(`SELECT * FROM ${tableName} LIMIT 100;`)
          } else {
            // Fallback to regular textarea
            const queryInput = document.getElementById("query")
            if (queryInput) {
              queryInput.value = `SELECT * FROM ${tableName} LIMIT 100;`
            }
          }

          // Trigger the query execution
          const form = document.querySelector('[data-controller="query-executor"]')
          if (form) {
            const submitButton = form.querySelector('button[type="submit"]')
            if (submitButton) {
              submitButton.click()
            } else {
              form.requestSubmit()
            }
          }
        }
      }

      // Saved Queries Controller
      class SavedQueriesController extends Controller {
        static targets = ["queryInput", "queryName", "queryDescription", "databaseSelector", "list", "saveError"]

        connect() {
          console.log("SavedQueries controller connected")
          this.loadSavedQueries()
          this.initializeCodeMirror()
        }

        initializeCodeMirror() {
          if (typeof CodeMirror !== 'undefined' && this.hasQueryInputTarget) {
            this.editor = CodeMirror.fromTextArea(this.queryInputTarget, {
              mode: 'text/x-sql',
              theme: 'default',
              lineNumbers: true,
              lineWrapping: true,
              autoCloseBrackets: true,
              matchBrackets: true,
              indentWithTabs: true,
              smartIndent: true,
              extraKeys: {
                "Ctrl-Enter": () => this.execute(),
                "Cmd-Enter": () => this.execute(),
                "Ctrl-Space": "autocomplete"
              }
            })
          }
        }

        async loadSavedQueries() {
          try {
            const response = await fetch('/sqlite_dashboard/saved_queries')
            const queries = await response.json()
            this.renderSavedQueries(queries)
          } catch (error) {
            console.error('Error loading saved queries:', error)
            if (this.hasListTarget) {
              this.listTarget.innerHTML = `<div class="text-danger small text-center py-3"><i class="fas fa-exclamation-triangle"></i> Error loading queries</div>`
            }
          }
        }

        renderSavedQueries(queries) {
          if (!this.hasListTarget) return

          if (queries.length === 0) {
            this.listTarget.innerHTML = `<div class="text-muted small text-center py-3">No saved queries</div>`
            return
          }

          const html = queries.map(query => `
            <div class="saved-query-item" data-query-id="${query.id}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1" style="cursor: pointer;"
                     data-action="click->saved-queries#loadQuery"
                     data-query-id="${query.id}"
                     data-query-name="${this.escapeHtml(query.name)}"
                     data-query-sql="${this.escapeHtml(query.query)}"
                     data-query-database="${query.database_name || ''}">
                  <div class="fw-bold small">${this.escapeHtml(query.name)}</div>
                  ${query.description ? `<div class="text-muted" style="font-size: 0.75rem;">${this.escapeHtml(query.description)}</div>` : ''}
                  ${query.database_name ? `<div class="text-info" style="font-size: 0.7rem;"><i class="fas fa-database"></i> ${this.escapeHtml(query.database_name)}</div>` : ''}
                </div>
                <button class="btn btn-sm btn-link text-danger p-0" data-action="click->saved-queries#deleteQuery" data-query-id="${query.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join('')

          this.listTarget.innerHTML = html
        }

        escapeHtml(text) {
          const div = document.createElement('div')
          div.textContent = text
          return div.innerHTML
        }

        async execute() {
          const databaseId = this.databaseSelectorTarget.value
          if (!databaseId) {
            alert('Please select a database first')
            return
          }

          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          if (!query.trim()) {
            alert('Please enter a query')
            return
          }

          try {
            const response = await fetch(`/sqlite_dashboard/databases/${databaseId}/execute_query`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
              },
              body: JSON.stringify({ query })
            })

            const data = await response.json()

            if (data.error) {
              this.renderError(data.error)
            } else {
              this.renderResults(data, query, databaseId)
            }
          } catch (error) {
            console.error('Error executing query:', error)
            this.renderError(error.message)
          }
        }

        renderResults(data) {
          const resultsContainer = document.getElementById('worksheet-results')

          if (data.message) {
            resultsContainer.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${data.message}</div>`
            return
          }

          const { columns, rows } = data

          let html = `
            <div class="results-header">
              <h6>Query Results</h6>
              <div class="text-muted small">${rows.length} row(s) returned</div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead><tr>${columns.map(col => `<th>${this.escapeHtml(col)}</th>`).join('')}</tr></thead>
                <tbody>
                  ${rows.map(row => `<tr>${row.map(cell => `<td>${cell !== null ? this.escapeHtml(String(cell)) : '<span class="text-muted">NULL</span>'}</td>`).join('')}</tr>`).join('')}
                </tbody>
              </table>
            </div>
          `

          resultsContainer.innerHTML = html
        }

        renderError(error) {
          const resultsContainer = document.getElementById('worksheet-results')
          resultsContainer.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${this.escapeHtml(error)}</div>`
        }

        clear() {
          if (this.editor) {
            this.editor.setValue('')
          } else {
            this.queryInputTarget.value = ''
          }
          document.getElementById('worksheet-results').innerHTML = `<div class="text-muted text-center py-5"><i class="fas fa-database fa-3x mb-3"></i><p>Select a database and execute a query to see results</p></div>`
        }

        async saveQuery() {
          const name = this.queryNameTarget.value.trim()
          const description = this.queryDescriptionTarget.value.trim()
          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          const databaseId = this.databaseSelectorTarget.value
          const databaseName = databaseId ? this.databaseSelectorTarget.options[this.databaseSelectorTarget.selectedIndex].text : null

          if (!name) {
            this.showSaveError('Query name is required')
            return
          }

          if (!description) {
            this.showSaveError('Description is required')
            return
          }

          if (!query.trim()) {
            this.showSaveError('Query cannot be empty')
            return
          }

          try {
            const response = await fetch('/sqlite_dashboard/saved_queries', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
              },
              body: JSON.stringify({
                saved_query: { name, description, query, database_name: databaseName }
              })
            })

            const data = await response.json()

            if (response.ok) {
              const modal = bootstrap.Modal.getInstance(document.getElementById('saveQueryModal'))
              modal.hide()
              this.queryNameTarget.value = ''
              this.queryDescriptionTarget.value = ''
              this.hideSaveError()
              await this.loadSavedQueries()
              alert('Query saved successfully!')
            } else {
              this.showSaveError(data.error || 'Failed to save query')
            }
          } catch (error) {
            console.error('Error saving query:', error)
            this.showSaveError(error.message)
          }
        }

        showSaveError(message) {
          if (this.hasSaveErrorTarget) {
            this.saveErrorTarget.textContent = message
            this.saveErrorTarget.classList.remove('d-none')
          }
        }

        hideSaveError() {
          if (this.hasSaveErrorTarget) {
            this.saveErrorTarget.classList.add('d-none')
          }
        }

        loadQuery(event) {
          const element = event.currentTarget
          const queryName = element.dataset.queryName
          const querySql = element.dataset.querySql
          const queryDatabase = element.dataset.queryDatabase

          if (!confirm(`Load query "${queryName}" into the editor?`)) {
            return
          }

          if (this.editor) {
            this.editor.setValue(querySql)
          } else {
            this.queryInputTarget.value = querySql
          }

          if (queryDatabase && this.hasDatabaseSelectorTarget) {
            const option = Array.from(this.databaseSelectorTarget.options).find(opt => opt.text === queryDatabase)
            if (option) {
              this.databaseSelectorTarget.value = option.value
            }
          }
        }

        async deleteQuery(event) {
          event.stopPropagation()
          const queryId = event.currentTarget.dataset.queryId

          if (!confirm('Are you sure you want to delete this saved query?')) {
            return
          }

          try {
            const response = await fetch(`/sqlite_dashboard/saved_queries/${queryId}`, {
              method: 'DELETE',
              headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content }
            })

            if (response.ok) {
              await this.loadSavedQueries()
            } else {
              const data = await response.json()
              alert(data.error || 'Failed to delete query')
            }
          } catch (error) {
            console.error('Error deleting query:', error)
            alert('Failed to delete query')
          }
        }

        refresh() {
          this.loadSavedQueries()
        }

        async exportCSV() {
          const databaseId = this.databaseSelectorTarget.value
          if (!databaseId) {
            alert('Please select a database first')
            return
          }

          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          if (!query.trim()) {
            alert('Please enter a query')
            return
          }

          const form = document.createElement('form')
          form.method = 'POST'
          form.action = `/sqlite_dashboard/databases/${databaseId}/export_csv`
          const csrfToken = document.querySelector('[name="csrf-token"]').content
          form.innerHTML = `
            <input type="hidden" name="authenticity_token" value="${csrfToken}">
            <input type="hidden" name="query" value="${this.escapeHtml(query)}">
            <input type="hidden" name="include_headers" value="true">
          `
          document.body.appendChild(form)
          form.submit()
          document.body.removeChild(form)
        }

        async exportJSON() {
          const databaseId = this.databaseSelectorTarget.value
          if (!databaseId) {
            alert('Please select a database first')
            return
          }

          const query = this.editor ? this.editor.getValue() : this.queryInputTarget.value
          if (!query.trim()) {
            alert('Please enter a query')
            return
          }

          const form = document.createElement('form')
          form.method = 'POST'
          form.action = `/sqlite_dashboard/databases/${databaseId}/export_json`
          const csrfToken = document.querySelector('[name="csrf-token"]').content
          form.innerHTML = `
            <input type="hidden" name="authenticity_token" value="${csrfToken}">
            <input type="hidden" name="query" value="${this.escapeHtml(query)}">
            <input type="hidden" name="format" value="array">
            <input type="hidden" name="pretty_print" value="true">
          `
          document.body.appendChild(form)
          form.submit()
          document.body.removeChild(form)
        }
      }

      // Initialize Stimulus
      window.Stimulus = Application.start()
      Stimulus.register("query-executor", QueryExecutorController)
      Stimulus.register("table-selector", TableSelectorController)
      Stimulus.register("saved-queries", SavedQueriesController)
    </script>
  </head>

  <body>
    <div class="sqlite-dashboard-container">
      <%= yield %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>